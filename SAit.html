<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ametrin: Live Charts Rotator</title>
  <style>
    :root{
      /* –ö–û–õ–¨–û–†–ò/–®–†–ò–§–¢–ò */
      --bg:#ffffff; --fg:#0b1020; --bar-bg:#ffffff; --bar-fg:#0b1020; --accent:#ef4444;

      /* –ì–û–õ–û–í–ù–Ü –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –†–û–ó–ú–Ü–†–£ –°–¢–û–†–Ü–ù–ö–ò (–∫–µ—Ä—É—é—Ç—å—Å—è –∑ JS —á–µ—Ä–µ–∑ SETTINGS) */
      --content-max-w: 2400px;         /* –º–∞–∫—Å. —à–∏—Ä–∏–Ω–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∫–∏ */
      --stage-h: ;                     /* 86vh / 900px / calc(100vh - 140px); —è–∫—â–æ –ø—É—Å—Ç–æ ‚Äî –∞–≤—Ç–æ */
      --outer-pad: 10px 12px 0;        /* –≤—ñ–¥—Å—Ç—É–ø–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ .wrap */
      --radius: 14px;                  /* —Ä–∞–¥—ñ—É—Å —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—è —Å—Ü–µ–Ω/–∫–∞—Ä—Ç–æ–∫ */
      --page-scale: 1;                 /* –º–∞—Å—à—Ç–∞–± —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∫–∏ (0.8..1.2) */

      /* –Ü–Ω—à–µ */
      --header-pad: 10px;              /* –∑–º–µ–Ω—à–∏–≤ –ø–∞–¥—ñ–Ω–≥ —à–∞–ø–∫–∏, —â–æ–± –ø—ñ–¥–Ω—è—Ç–∏ —Å—Ü–µ–Ω—É */
      --fade-ms: 1700ms;
      --ease: cubic-bezier(0.16,1,0.3,1);
    }

    html, body {height:100%;}
    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      background:var(--bg); color:var(--fg);
    }

    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      padding:var(--header-pad) 16px; background:var(--bar-bg); color:var(--bar-fg);
      border-bottom:1px solid #e5e7eb
    }
    .left,.right{
      display:flex; flex-direction:column; gap:2px;   /* –¥–≤–∞ —Ä—è–¥–∏ */
    }

    .brand{font-weight:800; letter-spacing:.2px; line-height:1.1}
    .brand .dot{color:var(--accent)}

    .place{font-size:1.2rem; font-weight:800; line-height:1.1}
    .datetime{font-size:2.4rem; font-weight:900; line-height:1.05; text-align:right}
    .weather{font-size:1.05rem; opacity:.9; text-align:right}

    .wrap{
      display:flex; justify-content:center;
      padding: var(--outer-pad);
      transform: scale(var(--page-scale));         /* –º–∞—Å—à—Ç–∞–± —É—Å—ñ—î—ó —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ—ó ‚Äú—Å—Ç–æ—Ä—ñ–Ω–∫–∏‚Äù */
      transform-origin: top center;
    }
    .card{ width:100%; max-width: var(--content-max-w); }

    .stage{
      position:relative; width:100%;
      /* —è–∫—â–æ --stage-h –Ω–µ –∑–∞–¥–∞–Ω–∞ ‚Üí –∞–≤—Ç–æ-—Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—ñ–¥ –≤–∏—Å–æ—Ç–∏ –≤—ñ–∫–Ω–∞ –º—ñ–Ω—É—Å —à–∞–ø–∫–∞ */
      height: var(--stage-h, calc(100vh - (2*var(--header-pad) + 1px + 24px)));
      border:1px solid #e5e7eb; border-radius: var(--radius);
      overflow:hidden; background:#fff;
      contain:layout style paint;           /* —ñ–∑–æ–ª—è—Ü—ñ—è –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ */
    }

    .slide{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      opacity:0; background:#fff; will-change:opacity,transform;
      backface-visibility:hidden; transform:translateZ(0);
    }
    .slide iframe,.slide img{width:100%; height:100%; border:0; display:block}
    .slide img{
      object-fit:var(--img-fit, contain);
      object-position:var(--img-pos, center center);
      padding:var(--img-pad, 0px);
      max-width:var(--img-max-w, 100%);
      max-height:var(--img-max-h, 100%);
      transform:scale(var(--img-scale, 1));
      background:var(--img-bg, #fff);
    }
    iframe::-webkit-scrollbar{display:none}

    .footer{ text-align:center; opacity:.6; font-size:.9rem; padding:8px }

    @media (max-width:640px){
      .place{font-size:1.05rem}
      .brand{font-size:1rem}
      .datetime{font-size:1.2rem}
      .weather{font-size:.95rem}
    }
    @media (prefers-reduced-motion:reduce){ :root{ --fade-ms:0ms } }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="left">
      <div id="place" class="place"></div>
      <div class="brand">Ametrin <span class="dot">‚Ä¢</span> –†–æ—Ç–∞—Ü—ñ—è –¥—ñ–∞–≥—Ä–∞–º</div>
    </div>
    <div class="right">
      <div id="datetime" class="datetime"></div>
      <div id="weather" class="weather"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div id="stage" class="stage"></div>
      <div class="footer">–£–∫—Ä–∞—ó–Ω–∞, –º. –ö–∏—ó–≤, 2025—Ä.</div>
    </div>
  </main>

<script>
  // ===== –ì–û–õ–û–í–ù–Ü –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –†–û–ó–ú–Ü–†–£ –°–¢–û–†–Ü–ù–ö–ò (–º—ñ–Ω—è—î—à —Ç—ñ–ª—å–∫–∏ —Ç—É—Ç) =====
  const SETTINGS = {
    maxWidth: 1820,          // —á–∏—Å–ª–æ (px) –∞–±–æ —Ä—è–¥–æ–∫ '90%' ‚Üí –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç—å—Å—è –≤ --content-max-w
    stageHeight: '88vh',     // '88vh', '900px', 'calc(100vh - 140px)' –∞–±–æ '' —â–æ–± –∞–≤—Ç–æ-–≤–∏—Å–æ—Ç–∞
    headerPadPx: 8,          // –∑–º–µ–Ω—à–µ–Ω–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –ø–∞–¥—ñ–Ω–≥ (—â–µ –≤–∏—â–µ —Å—Ü–µ–Ω–∞)
    outerPad: '8px 12px 0',  // —Ç—Ä–æ—Ö–∏ –º–µ–Ω—à–∏–π –≤–µ—Ä—Ö–Ω—ñ–π –≤—ñ–¥—Å—Ç—É–ø –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    radiusPx: 16,            // --radius
    pageScale: 1             // --page-scale (–º–∞—Å—à—Ç–∞–± —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ—ó –∫–∞—Ä—Ç–∫–∏)
  };

  // –ü—ñ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω—å —É CSS-–∑–º—ñ–Ω–Ω—ñ
  (function applySizeSettings(s){
    const r = document.documentElement;
    const toPx = v => (typeof v === 'number' ? v + 'px' : String(v));

    if (s.maxWidth !== undefined) r.style.setProperty('--content-max-w', toPx(s.maxWidth));
    if (s.stageHeight !== undefined && s.stageHeight !== '')
      r.style.setProperty('--stage-h', String(s.stageHeight));
    else
      r.style.removeProperty('--stage-h'); // –∞–≤—Ç–æ-—Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫

    if (s.headerPadPx !== undefined) r.style.setProperty('--header-pad', toPx(s.headerPadPx));
    if (s.outerPad !== undefined) r.style.setProperty('--outer-pad', String(s.outerPad));
    if (s.radiusPx !== undefined) r.style.setProperty('--radius', toPx(s.radiusPx));
    if (s.pageScale !== undefined) r.style.setProperty('--page-scale', String(s.pageScale));
  })(SETTINGS);

  // ===== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –†–û–¢–ê–¶–Ü–á/–ü–û–ì–û–î–ò =====
  const REGION = { lat:50.4501, lon:30.5234, label:"–ö–∏—ó–≤" };
  const DEFAULT_ROTATE_MS = 60_000;
  const CACHE_BUST_MINUTES = 5;
  const WEATHER_REFRESH_MIN = 10;

  // ===== –ü–õ–ï–ô–õ–ò–°–¢ =====
  const PLAYLIST = [
    // Google Sheets (–∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Ö–µ–¥–µ—Ä—ñ–≤ —É normalizeSheetsUrl)
    { type:'chart', url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vT1A9jHUrRE2MRSHGVX2x3HAZ9AU_CSadqAYkgI84wWylFRrR-WQuiLnNT6_tJXi3-bkwO6SZBNV4Rq/pubhtml?gid=1246423862&single=true" },
    { type:'chart', url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vT1A9jHUrRE2MRSHGVX2x3HAZ9AU_CSadqAYkgI84wWylFRrR-WQuiLnNT6_tJXi3-bkwO6SZBNV4Rq/pubhtml?gid=32794338&single=true" },
    { type:'chart', url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vT1A9jHUrRE2MRSHGVX2x3HAZ9AU_CSadqAYkgI84wWylFRrR-WQuiLnNT6_tJXi3-bkwO6SZBNV4Rq/pubhtml?gid=2095647029&single=true" },
    { type:'chart', url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vT1A9jHUrRE2MRSHGVX2x3HAZ9AU_CSadqAYkgI84wWylFRrR-WQuiLnNT6_tJXi3-bkwO6SZBNV4Rq/pubhtml?gid=1406852426&single=true" },
    { type:'chart', url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vT1A9jHUrRE2MRSHGVX2x3HAZ9AU_CSadqAYkgI84wWylFRrR-WQuiLnNT6_tJXi3-bkwO6SZBNV4Rq/pubhtml?gid=1930798029&single=true" },
    { type:'chart', url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vT1A9jHUrRE2MRSHGVX2x3HAZ9AU_CSadqAYkgI84wWylFRrR-WQuiLnNT6_tJXi3-bkwO6SZBNV4Rq/pubhtml?gid=993430037&single=true" },
    { type:'chart', url:"https://docs.google.com/spreadsheets/d/e/2PACX-1vT1A9jHUrRE2MRSHGVX2x3HAZ9AU_CSadqAYkgI84wWylFRrR-WQuiLnNT6_tJXi3-bkwO6SZBNV4Rq/pubhtml?gid=933193236&single=true" },


    // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∑ —Ç–æ–Ω–∫–∏–º –∫–µ—Ä—É–≤–∞–Ω–Ω—è–º —Ä–æ–∑–º—ñ—Ä–æ–º
    { type:'image', url:"https://ametrin.biz/img/Ametrin.jpg",
      fit:'contain', scale:1.15, maxW:'50%', maxH:'50%', pad:'12px', align:'center center', bg:'#fff' },
  ];

  // ===== –£–¢–ò–õ–Ü–¢–ò =====
  function normalizeSheetsUrl(u){
    try{
      const url = new URL(u);
      if (url.href.includes('pubhtml')){
        url.hash = '';
        url.searchParams.set('widget','true');
        url.searchParams.set('headers','false');
        url.searchParams.set('chrome','false');
      }
      return url.toString();
    }catch{ return u; }
  }
  function withCacheBuster(u){
    if (!CACHE_BUST_MINUTES) return u;
    try{
      const url = new URL(u, location.href);
      const bucket = Math.floor(Date.now() / (CACHE_BUST_MINUTES*60*1000));
      url.searchParams.set('_cb', String(bucket));
      return url.toString();
    }catch{ return u; }
  }

  function applyImageVars(img, opts = {}){
    const style = img.style;
    if (opts.fit)   style.setProperty('--img-fit', opts.fit);
    if (opts.align) style.setProperty('--img-pos', opts.align);
    if (opts.pad)   style.setProperty('--img-pad', opts.pad);
    if (opts.maxW)  style.setProperty('--img-max-w', opts.maxW);
    if (opts.maxH)  style.setProperty('--img-max-h', opts.maxH);
    if (opts.scale) style.setProperty('--img-scale', String(opts.scale));
    if (opts.bg)    style.setProperty('--img-bg', opts.bg);
  }

  function createSlideNode(item){
    const slide = document.createElement('div');
    slide.className = 'slide';
    if (item.type === 'image'){
      const img = document.createElement('img');
      img.alt = '';
      img.decoding = 'async';
      img.loading = 'eager';
      img.src = withCacheBuster(item.url);
      img.onerror = ()=>{ img.alt = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è'; };
      applyImageVars(img, {
        fit:item.fit, scale:item.scale, maxW:item.maxW, maxH:item.maxH,
        pad:item.pad, align:item.align, bg:item.bg
      });
      slide.appendChild(img);
    } else {
      const iframe = document.createElement('iframe');
      iframe.referrerPolicy = 'no-referrer';
      iframe.scrolling = 'no';
      iframe.allowFullscreen = true;
      iframe.src = withCacheBuster(normalizeSheetsUrl(item.url));
      slide.appendChild(iframe);
    }
    return slide;
  }

  function preloadIfImage(item){
    return new Promise(res=>{
      if (item.type !== 'image') return res();
      const i = new Image();
      i.onload = res; i.onerror = res;
      i.src = withCacheBuster(item.url);
    });
  }
  function waitIframeLoad(slide){
    return new Promise(res=>{
      const iframe = slide.querySelector('iframe');
      if (!iframe) return res();
      const done = ()=>res();
      const t = setTimeout(done, 2500);
      iframe.addEventListener('load', ()=>{ clearTimeout(t); done(); }, {once:true});
    });
  }

  // ===== –ê–ù–Ü–ú–ê–¶–Ü–Ø (–∫—Ä–æ—Å—Ñ–µ–π–¥ –∑ WAAPI) =====
  const DURATION = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--fade-ms')) || 900;
  const EASING   = getComputedStyle(document.documentElement).getPropertyValue('--ease') || 'ease';

  function animateIn(el){
    const prefersNoMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersNoMotion || !DURATION) { el.style.opacity = 1; return Promise.resolve(); }
    el.style.opacity = 0;
    const anim = el.animate(
      [{opacity:0, transform:'scale(0.985)'},{opacity:1, transform:'scale(1)'}],
      {duration:DURATION, easing:EASING, fill:'forwards'}
    );
    return anim.finished.catch(()=>{});
  }
  function animateOut(el){
    const prefersNoMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersNoMotion || !DURATION) { el.style.opacity = 0; return Promise.resolve(); }
    const anim = el.animate(
      [{opacity:1, transform:'scale(1)'},{opacity:0, transform:'scale(1.005)'}],
      {duration:DURATION, easing:EASING, fill:'forwards'}
    );
    return anim.finished.catch(()=>{});
  }

  // ===== –†–û–¢–ê–¶–Ü–Ø =====
  const stage = document.getElementById('stage');
  let idx = Number(localStorage.getItem('ametrin_idx') || 0);
  if (!Number.isInteger(idx) || idx < 0 || idx >= PLAYLIST.length) idx = 0;

  let currentSlide = null;
  let nextTimer = null;
  let paused = false;

  function scheduleNext(ms){ clearTimeout(nextTimer); if (!paused) nextTimer = setTimeout(()=> show(idx+1), ms); }
  function pause(){ paused = true; clearTimeout(nextTimer); }
  function resume(){ if (!paused) return; paused = false; scheduleNext(DEFAULT_ROTATE_MS); }

  async function show(i){
    if (!PLAYLIST.length) return;
    idx = (i + PLAYLIST.length) % PLAYLIST.length;
    localStorage.setItem('ametrin_idx', String(idx));
    const item = PLAYLIST[idx];

    await preloadIfImage(item);
    const incoming = createSlideNode(item);
    stage.appendChild(incoming);

    await waitIframeLoad(incoming);

    // –ø–æ–¥–≤—ñ–π–Ω–∏–π rAF ‚Äî –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ, —â–æ layout –∑–∞—Å—Ç–æ—Å–æ–≤–∞–Ω–∏–π –ø–µ—Ä–µ–¥ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
    await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));

    const outgoing = currentSlide;
    await Promise.all([
      animateIn(incoming),
      outgoing ? animateOut(outgoing) : Promise.resolve()
    ]);

    if (outgoing && outgoing.parentNode === stage) stage.removeChild(outgoing);
    currentSlide = incoming;
    scheduleNext(item.durationMs ?? DEFAULT_ROTATE_MS);
  }

  // —Å—Ç–∞—Ä—Ç
  show(idx);

  // –∫–µ—Ä—É–≤–∞–Ω–Ω—è
  document.addEventListener('visibilitychange', ()=>{ if (document.hidden) pause(); else resume(); });
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'ArrowRight'){ pause(); show(idx+1); }
    if (e.key === 'ArrowLeft'){  pause(); show(idx-1); }
    if (e.key === ' '){ e.preventDefault(); paused ? resume() : pause(); }
  });

  // ===== –ì–û–î–ò–ù–ù–ò–ö =====
  function updateClock(){
    const now = new Date();
    const dd = String(now.getDate()).padStart(2,'0');
    const mm = String(now.getMonth()+1).padStart(2,'0');
    const yyyy = now.getFullYear();
    const hh = String(now.getHours()).padStart(2,'0');
    const mi = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');
    document.getElementById('datetime').textContent = `${dd}.${mm}.${yyyy} ¬∑ ${hh}:${mi}:${ss}`;
  }
  updateClock(); setInterval(updateClock, 1000);

  // ===== –ü–û–ì–û–î–ê =====
  document.getElementById('place').textContent = REGION.label;
  async function loadWeather(){
    try{
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${REGION.lat}&longitude=${REGION.lon}&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m&timezone=auto`;
      const res = await fetch(url, {cache:'no-store'});
      const data = await res.json();
      const cur = data.current || {};
      const map = {0:'–Ø—Å–Ω–æ',1:'–ü–µ—Ä–µ–≤–∞–∂–Ω–æ —è—Å–Ω–æ',2:'–ú—ñ–Ω–ª–∏–≤–∞ —Ö–º–∞—Ä–Ω—ñ—Å—Ç—å',3:'–•–º–∞—Ä–Ω–æ',45:'–¢—É–º–∞–Ω',48:'–ü–∞–º–æ—Ä–æ–∑—å',51:'–ú—Ä—è–∫–∞ —Å–ª–∞–±–∫–∞',53:'–ú—Ä—è–∫–∞',55:'–ú—Ä—è–∫–∞ —Å–∏–ª—å–Ω–∞',61:'–î–æ—â —Å–ª–∞–±–∫–∏–π',63:'–î–æ—â',65:'–î–æ—â —Å–∏–ª—å–Ω–∏–π',66:'–ö—Ä–∏–∂–∞–Ω–∏–π –¥–æ—â —Å–ª–∞–±–∫–∏–π',67:'–ö—Ä–∏–∂–∞–Ω–∏–π –¥–æ—â —Å–∏–ª—å–Ω–∏–π',71:'–°–Ω—ñ–≥ —Å–ª–∞–±–∫–∏–π',73:'–°–Ω—ñ–≥',75:'–°–Ω—ñ–≥ —Å–∏–ª—å–Ω–∏–π',77:'–°–Ω—ñ–∂–Ω—ñ –∑–µ—Ä–Ω–∞',80:'–ó–ª–∏–≤–∏ —Å–ª–∞–±–∫—ñ',81:'–ó–ª–∏–≤–∏',82:'–ó–ª–∏–≤–∏ —Å–∏–ª—å–Ω—ñ',85:'–°–Ω—ñ–≥–æ–≤—ñ –∑–ª–∏–≤–∏ —Å–ª–∞–±–∫—ñ',86:'–°–Ω—ñ–≥–æ–≤—ñ –∑–ª–∏–≤–∏ —Å–∏–ª—å–Ω—ñ',95:'–ì—Ä–æ–∑–∞',96:'–ì—Ä–æ–∑–∞ –∑ –≥—Ä–∞–¥–æ–º',99:'–ì—Ä–æ–∑–∞ –∑ —Å–∏–ª—å–Ω–∏–º –≥—Ä–∞–¥–æ–º'};
      const t = cur.temperature_2m, w = cur.wind_speed_10m, code = Number(cur.weather_code ?? -1);
      document.getElementById('weather').textContent = (isFinite(t)&&isFinite(w)) ? `üå°Ô∏è ${t}¬∞C ¬∑ üí® ${w} –º/—Å ¬∑ ${map[code]||''}` : '‚Äî';
    }catch{ document.getElementById('weather').textContent = '–ü–æ–º–∏–ª–∫–∞ –ø–æ–≥–æ–¥–∏'; }
  }
  loadWeather(); setInterval(loadWeather, WEATHER_REFRESH_MIN*60*1000);
</script>
</body>
</html>
